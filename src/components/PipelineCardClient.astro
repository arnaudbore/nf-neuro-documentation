---
/**
 * Client-Side Pipeline Card
 * Renders a skeleton and hydrates with GitHub data on the client
 */

import { detectPipelineLogo } from '../utils/pipeline-logo';
import Icon from '../../node_modules/@astrojs/starlight/user-components/Icon.astro';
import StarIcon from '~icons/codicon/star-full';
import RepoForkedIcon from '~icons/codicon/repo-forked';
import ClockIcon from '~icons/codicon/history';
import TagIcon from '~icons/codicon/tag';
import LicenseIcon from '~icons/codicon/law';
import PersonIcon from '~icons/codicon/person';

interface Props {
  pipeline: {
    name: string;
    organisation: string;
    documentation?: string;
  };
  variant?: 'compact' | 'detailed';
  class?: string;
}

const { pipeline, variant = 'compact', class: className } = Astro.props;
const { name, organisation, documentation } = pipeline;

// Construct URLs
const repositoryName = `${organisation}/${name}`;
const githubUrl = `https://github.com/${repositoryName}`;
const hasDocumentation = !!documentation;
const primaryUrl = hasDocumentation ? documentation : githubUrl;

// Get logo at build time (static asset)
const logo = await detectPipelineLogo(organisation, name);

// Generate unique ID for this card
const cardId = `pipeline-card-${organisation}-${name}`.replace(/[^a-zA-Z0-9-]/g, '-');
---

<div 
  id={cardId}
  data-org={organisation}
  data-repo={name}
  data-variant={variant}
  data-has-docs={hasDocumentation}
  data-docs-url={documentation || ''}
  data-github-url={githubUrl}
  data-primary-url={primaryUrl}
  class:list={["pipeline-card-skeleton", className]}
  data-pipeline-card
>
  {variant === 'compact' ? (
    <!-- Compact Variant Skeleton -->
    <a 
      href={primaryUrl}
      class="flex gap-6 p-6 border border-gray-300 dark:border-gray-700 rounded-lg hover:shadow-lg hover:bg-gray-50 dark:hover:bg-gray-800 transition-all h-48 min-w-[600px] max-w-[800px] no-underline"
      target="_blank"
      rel="noopener noreferrer"
      data-card-link
    >
      <!-- Logo -->
      <div class="pipeline-logo flex-shrink-0 w-32 h-32 flex items-center justify-center">
        {logo.type === 'light-dark' ? (
          <>
            <img 
              src={logo.lightUrl} 
              alt={`${name} logo`}
              class="w-full h-full object-contain dark:hidden"
            />
            <img 
              src={logo.darkUrl} 
              alt={`${name} logo`}
              class="w-full h-full object-contain hidden dark:block"
            />
          </>
        ) : logo.type === 'single' ? (
          <img 
            src={logo.url} 
            alt={`${name} logo`}
            class="w-full h-full object-contain"
          />
        ) : null}
      </div>

      <!-- Content -->
      <div class="flex-1 flex flex-col justify-between py-2">
        <div class="flex flex-col gap-2">
          <h3 class="text-2xl font-bold text-gray-900 dark:text-gray-100">
            {repositoryName}
          </h3>
          <div class="pipeline-description text-sm text-gray-700 dark:text-gray-300 loading-skeleton mb-2" data-description>
            <div class="h-4 bg-gray-200 dark:bg-gray-700 rounded w-full animate-pulse"></div>
            <div class="h-4 bg-gray-200 dark:bg-gray-700 rounded w-3/4 animate-pulse mt-2"></div>
          </div>
        </div>
        <div class="flex gap-2 flex-wrap min-h-[28px]" data-topics>
          <!-- Topics will be inserted here -->
        </div>
      </div>
    </a>
  ) : (
    <!-- Detailed Variant Skeleton -->
    <div class="border border-gray-300 dark:border-gray-700 rounded-lg p-6 hover:shadow-lg transition-shadow">
      <div class="flex gap-6 mb-6">
        <!-- Logo -->
        <div class="pipeline-logo flex-shrink-0 w-28 h-28 flex items-center justify-center">
          {logo.type === 'light-dark' ? (
            <>
              <img 
                src={logo.lightUrl} 
                alt={`${name} logo`}
                class="w-full h-full object-contain dark:hidden"
              />
              <img 
                src={logo.darkUrl} 
                alt={`${name} logo`}
                class="w-full h-full object-contain hidden dark:block"
              />
            </>
          ) : logo.type === 'single' ? (
            <img 
              src={logo.url} 
              alt={`${name} logo`}
              class="w-full h-full object-contain"
            />
          ) : null}
        </div>

        <!-- Title and metadata -->
        <div class="flex-1 flex flex-col gap-3">
          <div class="flex items-start justify-between gap-4">
            <a 
              href={primaryUrl}
              target="_blank"
              rel="noopener noreferrer"
              class="text-2xl font-bold text-gray-900 dark:text-gray-100 hover:text-blue-600 dark:hover:text-blue-400 transition-colors no-underline"
              data-card-link
            >
              {repositoryName}
            </a>
            <div class="flex items-center gap-4 text-sm flex-wrap">
              <a 
                href="#"
                target="_blank"
                rel="noopener noreferrer"
                class="flex items-center gap-1 text-blue-600 dark:text-blue-400 hover:underline whitespace-nowrap hidden"
                title="Latest release"
                data-release-link
              >
                <TagIcon class="inline-icon" aria-hidden />
                <span data-release-tag></span>
              </a>
              
              <a 
                href="#"
                target="_blank"
                rel="noopener noreferrer"
                class="flex items-center gap-1 text-gray-700 dark:text-gray-300 hover:underline whitespace-nowrap hidden"
                data-license-link
              >
                <LicenseIcon class="inline-icon" aria-hidden />
                <span data-license-name></span>
              </a>
              
              <a 
                href="#"
                target="_blank"
                rel="noopener noreferrer"
                class="flex items-center gap-1 text-gray-700 dark:text-gray-300 hover:underline whitespace-nowrap hidden"
                title="Main contributor"
                data-contributor-link
              >
                <PersonIcon class="inline-icon" aria-hidden />
                <span data-contributor-name></span>
              </a>
              
              <div class="flex gap-3">
                {hasDocumentation && (
                  <a 
                    href={documentation}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="text-gray-600 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 transition-colors"
                    title="View Documentation"
                    data-docs-link
                  >
                    <Icon name="document" size="1.5rem" />
                  </a>
                )}
                <a 
                  href={githubUrl}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100 transition-colors"
                  title="View on GitHub"
                >
                  <Icon name="github" size="1.5rem" />
                </a>
              </div>
            </div>
          </div>

          <!-- Stats and topics row -->
          <div class="flex items-center justify-between gap-4">
            <div class="flex gap-4 text-sm text-gray-600 dark:text-gray-400">
              <span class="flex items-center gap-1 loading-skeleton">
                <StarIcon class="inline-icon" aria-hidden />
                <span data-stars>...</span>
              </span>
              <span class="flex items-center gap-1 loading-skeleton" title="Forks">
                <RepoForkedIcon class="inline-icon" aria-hidden />
                <span data-forks>...</span>
              </span>
              <span class="flex items-center gap-1 loading-skeleton" title="Last updated">
                <ClockIcon class="inline-icon" aria-hidden />
                <span data-updated>...</span>
              </span>
            </div>
            <div class="flex flex-wrap gap-2 justify-end" data-topics>
              <!-- Topics will be inserted here -->
            </div>
          </div>
        </div>
      </div>

      <!-- Description -->
      <div class="pipeline-description text-gray-700 dark:text-gray-300" data-description>
        <div class="h-4 bg-gray-200 dark:bg-gray-700 rounded w-full animate-pulse"></div>
        <div class="h-4 bg-gray-200 dark:bg-gray-700 rounded w-5/6 animate-pulse mt-2"></div>
      </div>
    </div>
  )}
</div>

<script>
  import { loadPipelineData } from '../scripts/pipeline-loader';
  
  async function hydratePipelineCard(card: HTMLElement) {
    const org = card.dataset.org!;
    const repo = card.dataset.repo!;
    const variant = card.dataset.variant as 'compact' | 'detailed';
    
    try {
      // Load data
      const data = await loadPipelineData(org, repo, variant);
      
      // Update description
      const descriptionEl = card.querySelector('[data-description]');
      if (descriptionEl) {
        const description = data.readmeDescription || data.repository.description || 'No description available';
        descriptionEl.innerHTML = description;
        descriptionEl.classList.remove('loading-skeleton');
      }
      
      // Update topics
      const topicsEl = card.querySelector('[data-topics]');
      if (topicsEl && data.repository.topics.length > 0) {
        topicsEl.innerHTML = data.repository.topics.map(topic => 
          `<span class="px-3 py-1 text-sm rounded-full bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300">${topic}</span>`
        ).join('');
      }
      
      // For detailed variant, update additional fields
      if (variant === 'detailed') {
        
        // Update stats
        const starsEl = card.querySelector('[data-stars]');
        const forksEl = card.querySelector('[data-forks]');
        const updatedEl = card.querySelector('[data-updated]');
        
        if (starsEl) starsEl.textContent = data.repository.stars.toString();
        if (forksEl) forksEl.textContent = data.repository.forks.toString();
        if (updatedEl) {
          updatedEl.textContent = new Date(data.repository.updatedAt).toLocaleDateString();
        }
        
        // Remove loading skeleton from stats
        card.querySelectorAll('[data-stars], [data-forks], [data-updated]').forEach(el => {
          el.closest('.loading-skeleton')?.classList.remove('loading-skeleton');
        });
        
        // Update release
        if (data.latestRelease) {
          const releaseLink = card.querySelector('[data-release-link]') as HTMLAnchorElement;
          const releaseTag = card.querySelector('[data-release-tag]');
          if (releaseLink && releaseTag) {
            releaseLink.href = data.latestRelease.url;
            releaseTag.textContent = data.latestRelease.tagName;
            releaseLink.classList.remove('hidden');
          }
        }
        
        // Update license
        if (data.repository.license) {
          const licenseLink = card.querySelector('[data-license-link]') as HTMLAnchorElement;
          const licenseName = card.querySelector('[data-license-name]');
          if (licenseLink && licenseName) {
            licenseLink.href = data.repository.license.url;
            licenseLink.title = data.repository.license.name;
            licenseName.textContent = data.repository.license.spdxId;
            licenseLink.classList.remove('hidden');
          }
        }
        
        // Update contributor
        if (data.mainContributor) {
          const contributorLink = card.querySelector('[data-contributor-link]') as HTMLAnchorElement;
          const contributorName = card.querySelector('[data-contributor-name]');
          if (contributorLink && contributorName) {
            contributorLink.href = data.mainContributor.url;
            contributorName.textContent = data.mainContributor.login;
            contributorLink.classList.remove('hidden');
          }
        }
      }
      
      // Remove skeleton class
      card.classList.remove('pipeline-card-skeleton');
      
    } catch (error) {
      console.error(`Failed to load pipeline data for ${org}/${repo}:`, error);
      // Show error state
      const descriptionEl = card.querySelector('[data-description]');
      if (descriptionEl) {
        descriptionEl.innerHTML = '<p class="text-red-600 dark:text-red-400">Failed to load pipeline data</p>';
      }
    }
  }
  
  // Hydrate all pipeline cards on page load
  document.addEventListener('DOMContentLoaded', () => {
    const cards = document.querySelectorAll('[data-pipeline-card]') as NodeListOf<HTMLElement>;
    cards.forEach(card => hydratePipelineCard(card));
  });
</script>

<style>
  .inline-icon {
    display: inline-block;
    width: 1em;
    height: 1em;
    vertical-align: -0.125em;
  }
  
  .pipeline-description {
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    line-clamp: 3;
  }
  
  /* Detailed cards show more description */
  [data-variant="detailed"] .pipeline-description {
    -webkit-line-clamp: 6;
    line-clamp: 6;
  }
</style>
